name: Stock Analysis Pipeline

on:
  schedule:
    # Weekdays (Mon–Fri): every 2 hours
    - cron: "0 5-23/2 * * 1-5"
    # Weekends (Sat–Sun): every 6 hours
    - cron: "0 5-23/6 * * 6,0"
  workflow_dispatch: # Manual trigger

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
  MAX_STOCKS: 100
  DAYS_BACK: 90
  PREDICTION_DAYS: 30

jobs:
  analyze-stocks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          cd scripts/stock-analysis
          # Ensure pip in the selected Python is used
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m nltk.downloader vader_lexicon

      - name: Run analysis pipeline
        env:
          PYTHONPATH: scripts/stock-analysis
        run: |
          # Ensure we run from the repository root so relative paths resolve the same as local runs
          cd scripts/stock-analysis
          # Export PYTHONPATH for the current shell (redundant with env but explicit for clarity)
          export PYTHONPATH=$(pwd):$PYTHONPATH
          python main.py
      - name: Check required env
        run: |
          python - <<'PY'
          import os, json
          keys = ["NEXT_PUBLIC_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_ANON_KEY"]
          print(json.dumps({k: bool(os.getenv(k)) for k in keys}))
          PY
      - name: Verify installed packages
        if: always()
        run: |
          python - <<'PY'
          import importlib, importlib.util, json
          pkgs = ['pandas','numpy','yfinance','nltk','supabase']
          out = {}
          for p in pkgs:
              spec = importlib.util.find_spec(p)
              if spec:
                  try:
                      m = importlib.import_module(p)
                      ver = getattr(m, '__version__', 'unknown')
                  except Exception:
                      ver = 'import-error'
                  out[p] = ver
              else:
                  out[p] = None
          print(json.dumps(out))
          PY
