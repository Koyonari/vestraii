name: Stock Analysis Pipeline
on:
  schedule:
    # Weekdays (Mon–Fri): every 2 hours
    - cron: "0 5-23/2 * * 1-5"
    # Weekends (Sat–Sun): every 6 hours
    - cron: "0 5-23/6 * * 6,0"
  workflow_dispatch: # Manual trigger

env:
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  MAX_STOCKS: 100
  DAYS_BACK: 90
  PREDICTION_DAYS: 30

jobs:
  analyze-stocks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"
      
      - name: Install dependencies
        run: |
          cd scripts/stock-analysis
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m nltk.downloader vader_lexicon
      
      - name: Check required env
        run: |
          python - <<'PY'
          import os, json
          keys = ["NEXT_PUBLIC_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_ANON_KEY"]
          result = {k: bool(os.getenv(k)) for k in keys}
          print(json.dumps(result, indent=2))
          for k, v in result.items():
              print(f"{k}: {'✓ SET' if v else '✗ NOT SET'}")
          PY
      
      - name: Run analysis pipeline
        run: |
          cd scripts/stock-analysis
          python main.py
      
      - name: Verify installed packages
        if: always()
        run: |
          python - <<'PY'
          import importlib, importlib.util, json
          pkgs = ['pandas','numpy','yfinance','nltk','supabase']
          out = {}
          for p in pkgs:
              spec = importlib.util.find_spec(p)
              if spec:
                  try:
                      m = importlib.import_module(p)
                      ver = getattr(m, '__version__', 'unknown')
                  except Exception:
                      ver = 'import-error'
                  out[p] = ver
              else:
                  out[p] = None
          print(json.dumps(out, indent=2))
          PY
